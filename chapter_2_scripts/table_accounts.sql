CREATE TABLE accounts2(
id integer PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
client text,
amount numeric
);


INSERT INTO accounts VALUES
(1, 'alice', 1000.00),
(2, 'bob', 100.00),
(3, 'bob', 900.00);


-- Аномалия неповторяющиеся чтение
-- транзакция 1
begin;
update accounts SET amount = amount -200 where id =1;


-- транзакция 2 в новом окне начинаем транзакцию и смотрим
BEGIN;
select * from accounts where client = 'alice';

-- транзакция 1 вызываем commit
COMMIT;

-- транзакция 2 опять читаем
select * from accounts where client = 'alice';



BEGIN ISOLATION LEVEL REPEATABLE READ;

-- посмотреть номер текущей транзакции
SELECT pg_current_xact_id();

-- посмотреть номера транзакций для строк
select xmin, xmax, * from accounts;


CREATE EXTENSION pageinspect;

SELECT lower, upper, special, pagesize FROM page_header(get_raw_page('accounts',0));

SELECT * FROM heap_page_items(get_raw_page('accounts',0))


SELECT * FROM accounts WHERE client = 'alice'  FOR UPDATE;